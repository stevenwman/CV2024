\documentclass[11pt]{article}

    \usepackage[breakable]{tcolorbox}
    \usepackage{parskip} % Stop auto-indenting (to mimic markdown behaviour)
    

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % Maintain compatibility with old templates. Remove in nbconvert 6.0
    \let\Oldincludegraphics\includegraphics
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionFormat{nocaption}{}
    \captionsetup{format=nocaption,aboveskip=0pt,belowskip=0pt}

    \usepackage{float}
    \floatplacement{figure}{H} % forces figures to be placed at the correct location
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro

    \usepackage{iftex}
    \ifPDFTeX
        \usepackage[T1]{fontenc}
        \IfFileExists{alphabeta.sty}{
              \usepackage{alphabeta}
          }{
              \usepackage[mathletters]{ucs}
              \usepackage[utf8x]{inputenc}
          }
    \else
        \usepackage{fontspec}
        \usepackage{unicode-math}
    \fi

    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics
                         % to support a larger range
    \makeatletter % fix for old versions of grffile with XeLaTeX
    \@ifpackagelater{grffile}{2019/11/01}
    {
      % Do nothing on new versions
    }
    {
      \def\Gread@@xetex#1{%
        \IfFileExists{"\Gin@base".bb}%
        {\Gread@eps{\Gin@base.bb}}%
        {\Gread@@xetex@aux#1}%
      }
    }
    \makeatother
    \usepackage[Export]{adjustbox} % Used to constrain images to a maximum size
    \adjustboxset{max size={0.9\linewidth}{0.9\paperheight}}

    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    % The default LaTeX title has an obnoxious amount of whitespace. By default,
    % titling removes some of it. It also provides customization options.
    \usepackage{titling}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage{array}     % table support for pandoc >= 2.11.3
    \usepackage{calc}      % table minipage width calculation for pandoc >= 2.11.1
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{soul}      % strikethrough (\st) support for pandoc >= 3.0.0
    \usepackage{mathrsfs}
    

    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % common color for the border for error outputs.
    \definecolor{outerrorbackground}{HTML}{FFDFDF}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}

    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}


    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    \title{HW4\_Reconstruction}
    
    
    
    
    
    
    
% Pygments definitions
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\@namedef{PY@tok@w}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\@namedef{PY@tok@c}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cp}{\def\PY@tc##1{\textcolor[rgb]{0.61,0.40,0.00}{##1}}}
\@namedef{PY@tok@k}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kp}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kt}{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\@namedef{PY@tok@o}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@ow}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\@namedef{PY@tok@nb}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@nf}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@nc}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@nn}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@ne}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.80,0.25,0.22}{##1}}}
\@namedef{PY@tok@nv}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@no}{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\@namedef{PY@tok@nl}{\def\PY@tc##1{\textcolor[rgb]{0.46,0.46,0.00}{##1}}}
\@namedef{PY@tok@ni}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.44,0.44,0.44}{##1}}}
\@namedef{PY@tok@na}{\def\PY@tc##1{\textcolor[rgb]{0.41,0.47,0.13}{##1}}}
\@namedef{PY@tok@nt}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@nd}{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\@namedef{PY@tok@s}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sd}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@si}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.64,0.35,0.47}{##1}}}
\@namedef{PY@tok@se}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.36,0.12}{##1}}}
\@namedef{PY@tok@sr}{\def\PY@tc##1{\textcolor[rgb]{0.64,0.35,0.47}{##1}}}
\@namedef{PY@tok@ss}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@sx}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@m}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@gh}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\@namedef{PY@tok@gu}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\@namedef{PY@tok@gd}{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\@namedef{PY@tok@gi}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.52,0.00}{##1}}}
\@namedef{PY@tok@gr}{\def\PY@tc##1{\textcolor[rgb]{0.89,0.00,0.00}{##1}}}
\@namedef{PY@tok@ge}{\let\PY@it=\textit}
\@namedef{PY@tok@gs}{\let\PY@bf=\textbf}
\@namedef{PY@tok@gp}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\@namedef{PY@tok@go}{\def\PY@tc##1{\textcolor[rgb]{0.44,0.44,0.44}{##1}}}
\@namedef{PY@tok@gt}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\@namedef{PY@tok@err}{\def\PY@bc##1{{\setlength{\fboxsep}{\string -\fboxrule}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}}
\@namedef{PY@tok@kc}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kd}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kn}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@kr}{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@bp}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\@namedef{PY@tok@fm}{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\@namedef{PY@tok@vc}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vg}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vi}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@vm}{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\@namedef{PY@tok@sa}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sb}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sc}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@dl}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@s2}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@sh}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@s1}{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\@namedef{PY@tok@mb}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mf}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mh}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mi}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@il}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@mo}{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\@namedef{PY@tok@ch}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cm}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cpf}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@c1}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}
\@namedef{PY@tok@cs}{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.24,0.48,0.48}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % For linebreaks inside Verbatim environment from package fancyvrb.
    \makeatletter
        \newbox\Wrappedcontinuationbox
        \newbox\Wrappedvisiblespacebox
        \newcommand*\Wrappedvisiblespace {\textcolor{red}{\textvisiblespace}}
        \newcommand*\Wrappedcontinuationsymbol {\textcolor{red}{\llap{\tiny$\m@th\hookrightarrow$}}}
        \newcommand*\Wrappedcontinuationindent {3ex }
        \newcommand*\Wrappedafterbreak {\kern\Wrappedcontinuationindent\copy\Wrappedcontinuationbox}
        % Take advantage of the already applied Pygments mark-up to insert
        % potential linebreaks for TeX processing.
        %        {, <, #, %, $, ' and ": go to next line.
        %        _, }, ^, &, >, - and ~: stay at end of broken line.
        % Use of \textquotesingle for straight quote.
        \newcommand*\Wrappedbreaksatspecials {%
            \def\PYGZus{\discretionary{\char`\_}{\Wrappedafterbreak}{\char`\_}}%
            \def\PYGZob{\discretionary{}{\Wrappedafterbreak\char`\{}{\char`\{}}%
            \def\PYGZcb{\discretionary{\char`\}}{\Wrappedafterbreak}{\char`\}}}%
            \def\PYGZca{\discretionary{\char`\^}{\Wrappedafterbreak}{\char`\^}}%
            \def\PYGZam{\discretionary{\char`\&}{\Wrappedafterbreak}{\char`\&}}%
            \def\PYGZlt{\discretionary{}{\Wrappedafterbreak\char`\<}{\char`\<}}%
            \def\PYGZgt{\discretionary{\char`\>}{\Wrappedafterbreak}{\char`\>}}%
            \def\PYGZsh{\discretionary{}{\Wrappedafterbreak\char`\#}{\char`\#}}%
            \def\PYGZpc{\discretionary{}{\Wrappedafterbreak\char`\%}{\char`\%}}%
            \def\PYGZdl{\discretionary{}{\Wrappedafterbreak\char`\$}{\char`\$}}%
            \def\PYGZhy{\discretionary{\char`\-}{\Wrappedafterbreak}{\char`\-}}%
            \def\PYGZsq{\discretionary{}{\Wrappedafterbreak\textquotesingle}{\textquotesingle}}%
            \def\PYGZdq{\discretionary{}{\Wrappedafterbreak\char`\"}{\char`\"}}%
            \def\PYGZti{\discretionary{\char`\~}{\Wrappedafterbreak}{\char`\~}}%
        }
        % Some characters . , ; ? ! / are not pygmentized.
        % This macro makes them "active" and they will insert potential linebreaks
        \newcommand*\Wrappedbreaksatpunct {%
            \lccode`\~`\.\lowercase{\def~}{\discretionary{\hbox{\char`\.}}{\Wrappedafterbreak}{\hbox{\char`\.}}}%
            \lccode`\~`\,\lowercase{\def~}{\discretionary{\hbox{\char`\,}}{\Wrappedafterbreak}{\hbox{\char`\,}}}%
            \lccode`\~`\;\lowercase{\def~}{\discretionary{\hbox{\char`\;}}{\Wrappedafterbreak}{\hbox{\char`\;}}}%
            \lccode`\~`\:\lowercase{\def~}{\discretionary{\hbox{\char`\:}}{\Wrappedafterbreak}{\hbox{\char`\:}}}%
            \lccode`\~`\?\lowercase{\def~}{\discretionary{\hbox{\char`\?}}{\Wrappedafterbreak}{\hbox{\char`\?}}}%
            \lccode`\~`\!\lowercase{\def~}{\discretionary{\hbox{\char`\!}}{\Wrappedafterbreak}{\hbox{\char`\!}}}%
            \lccode`\~`\/\lowercase{\def~}{\discretionary{\hbox{\char`\/}}{\Wrappedafterbreak}{\hbox{\char`\/}}}%
            \catcode`\.\active
            \catcode`\,\active
            \catcode`\;\active
            \catcode`\:\active
            \catcode`\?\active
            \catcode`\!\active
            \catcode`\/\active
            \lccode`\~`\~
        }
    \makeatother

    \let\OriginalVerbatim=\Verbatim
    \makeatletter
    \renewcommand{\Verbatim}[1][1]{%
        %\parskip\z@skip
        \sbox\Wrappedcontinuationbox {\Wrappedcontinuationsymbol}%
        \sbox\Wrappedvisiblespacebox {\FV@SetupFont\Wrappedvisiblespace}%
        \def\FancyVerbFormatLine ##1{\hsize\linewidth
            \vtop{\raggedright\hyphenpenalty\z@\exhyphenpenalty\z@
                \doublehyphendemerits\z@\finalhyphendemerits\z@
                \strut ##1\strut}%
        }%
        % If the linebreak is at a space, the latter will be displayed as visible
        % space at end of first line, and a continuation symbol starts next line.
        % Stretch/shrink are however usually zero for typewriter font.
        \def\FV@Space {%
            \nobreak\hskip\z@ plus\fontdimen3\font minus\fontdimen4\font
            \discretionary{\copy\Wrappedvisiblespacebox}{\Wrappedafterbreak}
            {\kern\fontdimen2\font}%
        }%

        % Allow breaks at special characters using \PYG... macros.
        \Wrappedbreaksatspecials
        % Breaks at punctuation characters . , ; ? ! and / need catcode=\active
        \OriginalVerbatim[#1,codes*=\Wrappedbreaksatpunct]%
    }
    \makeatother

    % Exact colors from NB
    \definecolor{incolor}{HTML}{303F9F}
    \definecolor{outcolor}{HTML}{D84315}
    \definecolor{cellborder}{HTML}{CFCFCF}
    \definecolor{cellbackground}{HTML}{F7F7F7}

    % prompt
    \makeatletter
    \newcommand{\boxspacing}{\kern\kvtcb@left@rule\kern\kvtcb@boxsep}
    \makeatother
    \newcommand{\prompt}[4]{
        {\ttfamily\llap{{\color{#2}[#3]:\hspace{3pt}#4}}\vspace{-\baselineskip}}
    }
    

    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

\begin{document}
    
    \maketitle
    
    

    
    After your finish the assignment, remember to run all cells and save the
note book to your local machine as a PDF for gradescope submission by
pressing Ctrl-P or Cmd-P. Make sure images are not split between pages;
insert Text blocks to make sure this is the case before printing to PDF!

    List your collaborators here:

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

    \hypertarget{hw-4-3d-reconstruction}{%
\section{\texorpdfstring{\textbf{16720 HW 4: 3D
Reconstruction}}{16720 HW 4: 3D Reconstruction}}\label{hw-4-3d-reconstruction}}

\hypertarget{problem-1-theory}{%
\section{Problem 1: Theory}\label{problem-1-theory}}

    \hypertarget{section}{%
\subsection{1.1}\label{section}}

See pdf for the question.

    \hypertarget{your-answer-here-for-1.1}{%
\section{===== your answer here for 1.1!
=====}\label{your-answer-here-for-1.1}}

Epipolar constraint: \[\begin{align*}x^T_2 F x_1 &= 0 \\ 
    \begin{bmatrix} 0 & 0 & 1 \end{bmatrix}
    \begin{bmatrix} F_{11} & F_{13} & F_{13} \\
                    F_{21} & F_{23} & F_{23} \\ 
                    F_{31} & F_{33} & F_{33} \\\end{bmatrix}
    \begin{bmatrix} 0 \\ 0 \\ 1 \end{bmatrix} &= 0 \\
    \begin{bmatrix} 0 & 0 & 1 \end{bmatrix}
    \begin{bmatrix} F_{13} \\
                    F_{23} \\ 
                    F_{33} \\\end{bmatrix} &= 0 \\
                    F_{33} &= 0
\end{align*}\] \# ===== end of your answer for 1.1 =====

    \hypertarget{section}{%
\subsection{1.2}\label{section}}

See pdf for the question.

    \hypertarget{your-answer-here-for-1.2}{%
\section{===== your answer here for 1.2!
=====}\label{your-answer-here-for-1.2}}

Relative translation: \[R_{rel} = R_{2}R_{1}^{T}\]
\[t_{rel} = t_2 - t_1\]

Roto-translation: \[C2 = C1\ R_{rel} + t_{rel}\]

Essential and fundamental matrices: \[E = [t_{rel,\times}]R_{rel}\]
\[F = K^{-T}EK^{-1} = K^{-T}[t_{rel,\times}]R_{rel}K^{-1}\]

\hypertarget{end-of-your-answer-for-1.2}{%
\section{===== end of your answer for 1.2
=====}\label{end-of-your-answer-for-1.2}}

    \hypertarget{coding}{%
\section{\texorpdfstring{\textbf{Coding}}{Coding}}\label{coding}}

    \hypertarget{initialization}{%
\subsection{\texorpdfstring{\textbf{Initialization}}{Initialization}}\label{initialization}}

Run the following code, which imports the modules you'll need and
defines helper functions you may need to use later in your
implementations.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{1}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{import} \PY{n+nn}{os}
\PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
\PY{k+kn}{import} \PY{n+nn}{scipy}
\PY{k+kn}{import} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{optimize}
\PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
\PY{k+kn}{from} \PY{n+nn}{mpl\PYZus{}toolkits}\PY{n+nn}{.}\PY{n+nn}{mplot3d} \PY{k+kn}{import} \PY{n}{Axes3D}
\PY{c+c1}{\PYZsh{} from google.colab.patches import cv2\PYZus{}imshow}
\PY{k+kn}{import} \PY{n+nn}{cv2}


\PY{n}{connections\PYZus{}3d} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{11}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{10}\PY{p}{,}\PY{l+m+mi}{11}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{10}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{]}\PY{p}{,}
                  \PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{10}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{7}\PY{p}{,}\PY{l+m+mi}{11}\PY{p}{]}\PY{p}{]}
\PY{n}{color\PYZus{}links} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{]}
\PY{n}{colors} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{blue}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{blue}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{blue}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{blue}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{magenta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{green}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{green}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{green}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{green}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{magenta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{magenta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{magenta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{magenta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}


\PY{k}{def} \PY{n+nf}{visualize\PYZus{}keypoints}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{pts}\PY{p}{,} \PY{n}{Threshold}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    This function visualizes the 2d keypoint pairs in connections\PYZus{}3d}
\PY{l+s+sd}{    (as define above) whose match score lies above a given Threshold}
\PY{l+s+sd}{    in an OpenCV GUI frame, against an image background.}

\PY{l+s+sd}{    :param image: image as a numpy array, of shape (height, width, 3) where 3 is the number of color channels}
\PY{l+s+sd}{    :param pts: np.array of shape (num\PYZus{}points, 3)}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
    \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{)}\PY{p}{:}
        \PY{n}{cx}\PY{p}{,} \PY{n}{cy} \PY{o}{=} \PY{n}{pts}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
        \PY{k}{if} \PY{n}{pts}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{Threshold}\PY{p}{:}
            \PY{n}{cv2}\PY{o}{.}\PY{n}{circle}\PY{p}{(}\PY{n}{image}\PY{p}{,}\PY{p}{(}\PY{n+nb}{int}\PY{p}{(}\PY{n}{cx}\PY{p}{)}\PY{p}{,}\PY{n+nb}{int}\PY{p}{(}\PY{n}{cy}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}

    \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{connections\PYZus{}3d}\PY{p}{)}\PY{p}{)}\PY{p}{:}
        \PY{n}{idx0}\PY{p}{,} \PY{n}{idx1} \PY{o}{=} \PY{n}{connections\PYZus{}3d}\PY{p}{[}\PY{n}{i}\PY{p}{]}
        \PY{k}{if} \PY{n}{pts}\PY{p}{[}\PY{n}{idx0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{Threshold} \PY{o+ow}{and} \PY{n}{pts}\PY{p}{[}\PY{n}{idx1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{Threshold}\PY{p}{:}
            \PY{n}{x0}\PY{p}{,} \PY{n}{y0} \PY{o}{=} \PY{n}{pts}\PY{p}{[}\PY{n}{idx0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
            \PY{n}{x1}\PY{p}{,} \PY{n}{y1} \PY{o}{=} \PY{n}{pts}\PY{p}{[}\PY{n}{idx1}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
            \PY{n}{cv2}\PY{o}{.}\PY{n}{line}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{p}{(}\PY{n+nb}{int}\PY{p}{(}\PY{n}{x0}\PY{p}{)}\PY{p}{,} \PY{n+nb}{int}\PY{p}{(}\PY{n}{y0}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n+nb}{int}\PY{p}{(}\PY{n}{x1}\PY{p}{)}\PY{p}{,} \PY{n+nb}{int}\PY{p}{(}\PY{n}{y1}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{color\PYZus{}links}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} cv2\PYZus{}imshow(image)}
    \PY{n}{cv2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}

    \PY{k}{return} \PY{n}{image}


\PY{k}{def} \PY{n+nf}{plot\PYZus{}3d\PYZus{}keypoint}\PY{p}{(}\PY{n}{pts\PYZus{}3d}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    this function visualizes 3d keypoints on a matplotlib 3d axes}

\PY{l+s+sd}{    :param pts\PYZus{}3d: np.array of shape (num\PYZus{}points, 3)}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
    \PY{n}{num\PYZus{}points} \PY{o}{=} \PY{n}{pts\PYZus{}3d}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
    \PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{connections\PYZus{}3d}\PY{p}{)}\PY{p}{)}\PY{p}{:}
        \PY{n}{index0}\PY{p}{,} \PY{n}{index1} \PY{o}{=} \PY{n}{connections\PYZus{}3d}\PY{p}{[}\PY{n}{j}\PY{p}{]}
        \PY{n}{xline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
        \PY{n}{yline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}
        \PY{n}{zline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{]}
        \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{xline}\PY{p}{,} \PY{n}{yline}\PY{p}{,} \PY{n}{zline}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{)}
    \PY{n}{np}\PY{o}{.}\PY{n}{set\PYZus{}printoptions}\PY{p}{(}\PY{n}{threshold}\PY{o}{=}\PY{l+m+mf}{1e6}\PY{p}{,} \PY{n}{suppress}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{X Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Y Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}zlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Z Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}


\PY{k}{def} \PY{n+nf}{calc\PYZus{}epi\PYZus{}error}\PY{p}{(}\PY{n}{pts1\PYZus{}homo}\PY{p}{,} \PY{n}{pts2\PYZus{}homo}\PY{p}{,} \PY{n}{F}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    Helper function to calcualte the sum of squared distance between the}
\PY{l+s+sd}{    corresponding points and the estimated epipolar lines.}

\PY{l+s+sd}{    pts1\PYZus{}homo \PYZbs{}dot F.T \PYZbs{}dot pts2\PYZus{}homo = 0}

\PY{l+s+sd}{    :param pts1\PYZus{}homo: of shape (num\PYZus{}points, 3); in homogeneous coordinates, not normalized.}
\PY{l+s+sd}{    :param pts2\PYZus{}homo: same specification as to pts1\PYZus{}homo.}
\PY{l+s+sd}{    :param F: Fundamental matrix}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}

    \PY{n}{line1s} \PY{o}{=} \PY{n}{pts1\PYZus{}homo}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{F}\PY{o}{.}\PY{n}{T}\PY{p}{)}
    \PY{n}{dist1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}
        \PY{n}{line1s}\PY{p}{,} \PY{n}{pts2\PYZus{}homo}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{line1s}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{)}

    \PY{n}{line2s} \PY{o}{=} \PY{n}{pts2\PYZus{}homo}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{F}\PY{p}{)}
    \PY{n}{dist2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}
        \PY{n}{line2s}\PY{p}{,} \PY{n}{pts1\PYZus{}homo}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{line2s}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{)}

    \PY{n}{ress} \PY{o}{=} \PY{p}{(}\PY{n}{dist1} \PY{o}{+} \PY{n}{dist2}\PY{p}{)}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}
    \PY{k}{return} \PY{n}{ress}


\PY{k}{def} \PY{n+nf}{toHomogenous}\PY{p}{(}\PY{n}{pts}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
\PY{l+s+sd}{    Adds a stack of ones at the end, to turn a set of points into a set of}
\PY{l+s+sd}{    homogeneous points.}

\PY{l+s+sd}{    :params pts: in shape (num\PYZus{}points, 2).}
\PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
    \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{[}\PY{n}{pts}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{pts}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{pts}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{p}{)}


\PY{k}{def} \PY{n+nf}{\PYZus{}epipoles}\PY{p}{(}\PY{n}{E}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
\PY{l+s+sd}{    gets the epipoles from the Essential Matrix.}

\PY{l+s+sd}{    :params E: Essential matrix.}
\PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
    \PY{n}{U}\PY{p}{,} \PY{n}{S}\PY{p}{,} \PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{E}\PY{p}{)}
    \PY{n}{e1} \PY{o}{=} \PY{n}{V}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]}
    \PY{n}{U}\PY{p}{,} \PY{n}{S}\PY{p}{,} \PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{E}\PY{o}{.}\PY{n}{T}\PY{p}{)}
    \PY{n}{e2} \PY{o}{=} \PY{n}{V}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]}
    \PY{k}{return} \PY{n}{e1}\PY{p}{,} \PY{n}{e2}


\PY{k}{def} \PY{n+nf}{displayEpipolarF}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{I2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{points}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
\PY{l+s+sd}{    GUI interface you may use to help you verify your calculated fundamental}
\PY{l+s+sd}{    matrix F. Select a point I1 in one view, and it should correctly correspond}
\PY{l+s+sd}{    to the displayed point in the second view.}
\PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
    \PY{n}{e1}\PY{p}{,} \PY{n}{e2} \PY{o}{=} \PY{n}{\PYZus{}epipoles}\PY{p}{(}\PY{n}{F}\PY{p}{)}

    \PY{n}{sy}\PY{p}{,} \PY{n}{sx}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{I2}\PY{o}{.}\PY{n}{shape}

    \PY{n}{f}\PY{p}{,} \PY{p}{[}\PY{n}{ax1}\PY{p}{,} \PY{n}{ax2}\PY{p}{]} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplots}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
    \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
    \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{The point you selected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
    \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Verify that the corresponding point }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{ is on the epipolar line in this image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

    \PY{n}{plt}\PY{o}{.}\PY{n}{sca}\PY{p}{(}\PY{n}{ax1}\PY{p}{)}

    \PY{n}{colors} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{y}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{m}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
    \PY{k}{for} \PY{n}{i}\PY{p}{,} \PY{n}{out} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{points}\PY{p}{)}\PY{p}{:}
      \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n}{out} \PY{c+c1}{\PYZsh{}[0]}

      \PY{n}{xc} \PY{o}{=} \PY{n}{x}
      \PY{n}{yc} \PY{o}{=} \PY{n}{y}
      \PY{n}{v} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{xc}\PY{p}{,} \PY{n}{yc}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
      \PY{n}{l} \PY{o}{=} \PY{n}{F}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{p}{)}
      \PY{n}{s} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{+}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}

      \PY{k}{if} \PY{n}{s}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Zero line vector in displayEpipolar}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

      \PY{n}{l} \PY{o}{=} \PY{n}{l}\PY{o}{/}\PY{n}{s}

      \PY{k}{if} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{:}
          \PY{n}{ye} \PY{o}{=} \PY{n}{sy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
          \PY{n}{ys} \PY{o}{=} \PY{l+m+mi}{0}
          \PY{n}{xe} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{ye} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
          \PY{n}{xs} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{ys} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
      \PY{k}{else}\PY{p}{:}
          \PY{n}{xe} \PY{o}{=} \PY{n}{sx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
          \PY{n}{xs} \PY{o}{=} \PY{l+m+mi}{0}
          \PY{n}{ye} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{xe} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
          \PY{n}{ys} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{xs} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}

      \PY{c+c1}{\PYZsh{} plt.plot(x,y, \PYZsq{}*\PYZsq{}, \PYZsq{}MarkerSize\PYZsq{}, 6, \PYZsq{}LineWidth\PYZsq{}, 2);}
      \PY{n}{ax1}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{markersize}\PY{o}{=}\PY{l+m+mi}{6}\PY{p}{,} \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZpc{}}\PY{k}{len}(colors)])
      \PY{n}{ax2}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{xs}\PY{p}{,} \PY{n}{xe}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{ys}\PY{p}{,} \PY{n}{ye}\PY{p}{]}\PY{p}{,} \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZpc{}}\PY{k}{len}(colors)])
    \PY{n}{plt}\PY{o}{.}\PY{n}{draw}\PY{p}{(}\PY{p}{)}


\PY{k}{def} \PY{n+nf}{\PYZus{}singularize}\PY{p}{(}\PY{n}{F}\PY{p}{)}\PY{p}{:}
    \PY{n}{U}\PY{p}{,} \PY{n}{S}\PY{p}{,} \PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{F}\PY{p}{)}
    \PY{n}{S}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
    \PY{n}{F} \PY{o}{=} \PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{n}{S}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{)}
    \PY{k}{return} \PY{n}{F}

\PY{k}{def} \PY{n+nf}{\PYZus{}objective\PYZus{}F}\PY{p}{(}\PY{n}{f}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}\PY{p}{:}
    \PY{n}{F} \PY{o}{=} \PY{n}{\PYZus{}singularize}\PY{p}{(}\PY{n}{f}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}\PY{p}{)}
    \PY{n}{num\PYZus{}points} \PY{o}{=} \PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
    \PY{n}{hpts1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{pts1}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{[}\PY{n}{num\PYZus{}points}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{hpts2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{pts2}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{[}\PY{n}{num\PYZus{}points}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{Fp1} \PY{o}{=} \PY{n}{F}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{hpts1}\PY{o}{.}\PY{n}{T}\PY{p}{)}
    \PY{n}{FTp2} \PY{o}{=} \PY{n}{F}\PY{o}{.}\PY{n}{T}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{hpts2}\PY{o}{.}\PY{n}{T}\PY{p}{)}

    \PY{n}{r} \PY{o}{=} \PY{l+m+mi}{0}
    \PY{k}{for} \PY{n}{fp1}\PY{p}{,} \PY{n}{fp2}\PY{p}{,} \PY{n}{hp2} \PY{o+ow}{in} \PY{n+nb}{zip}\PY{p}{(}\PY{n}{Fp1}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{FTp2}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{hpts2}\PY{p}{)}\PY{p}{:}
        \PY{n}{r} \PY{o}{+}\PY{o}{=} \PY{p}{(}\PY{n}{hp2}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{fp1}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{*} \PY{p}{(}\PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{fp1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{fp1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{fp2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{fp2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
    \PY{k}{return} \PY{n}{r}

\PY{k}{def} \PY{n+nf}{refineF}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}\PY{p}{:}
    \PY{n}{f} \PY{o}{=} \PY{n}{scipy}\PY{o}{.}\PY{n}{optimize}\PY{o}{.}\PY{n}{fmin\PYZus{}powell}\PY{p}{(}
        \PY{k}{lambda} \PY{n}{x}\PY{p}{:} \PY{n}{\PYZus{}objective\PYZus{}F}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}\PY{p}{,} \PY{n}{F}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,}
        \PY{n}{maxiter}\PY{o}{=}\PY{l+m+mi}{100000}\PY{p}{,}
        \PY{n}{maxfun}\PY{o}{=}\PY{l+m+mi}{10000}\PY{p}{,}
        \PY{n}{disp}\PY{o}{=}\PY{k+kc}{False}
    \PY{p}{)}
    \PY{k}{return} \PY{n}{\PYZus{}singularize}\PY{p}{(}\PY{n}{f}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}\PY{p}{)}


\PY{c+c1}{\PYZsh{} Used in 4.2 Epipolar Correspondence}
\PY{k}{def} \PY{n+nf}{epipolarMatchGUI}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{I2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{points}\PY{p}{,} \PY{n}{epipolarCorrespondence}\PY{p}{)}\PY{p}{:}
    \PY{n}{e1}\PY{p}{,} \PY{n}{e2} \PY{o}{=} \PY{n}{\PYZus{}epipoles}\PY{p}{(}\PY{n}{F}\PY{p}{)}

    \PY{n}{sy}\PY{p}{,} \PY{n}{sx}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{I2}\PY{o}{.}\PY{n}{shape}

    \PY{n}{f}\PY{p}{,} \PY{p}{[}\PY{n}{ax1}\PY{p}{,} \PY{n}{ax2}\PY{p}{]} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplots}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
    \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I1}\PY{p}{)}
    \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{The point you selected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{I2}\PY{p}{)}
    \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Verify that the corresponding point }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{ is on the epipolar line in this image }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{and that the corresponding point matches}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

    \PY{n}{plt}\PY{o}{.}\PY{n}{sca}\PY{p}{(}\PY{n}{ax1}\PY{p}{)}

    \PY{n}{colors} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{y}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{m}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}

    \PY{k}{for} \PY{n}{i}\PY{p}{,} \PY{n}{out} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{points}\PY{p}{)}\PY{p}{:}
      \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n}{out}

      \PY{n}{xc} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{x}\PY{p}{)}
      \PY{n}{yc} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{y}\PY{p}{)}
      \PY{n}{v} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{xc}\PY{p}{,} \PY{n}{yc}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
      \PY{n}{l} \PY{o}{=} \PY{n}{F}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{v}\PY{p}{)}
      \PY{n}{s} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{+}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}

      \PY{k}{if} \PY{n}{s}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Zero line vector in displayEpipolar}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

      \PY{n}{l} \PY{o}{=} \PY{n}{l}\PY{o}{/}\PY{n}{s}

      \PY{k}{if} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{:}
          \PY{n}{ye} \PY{o}{=} \PY{n}{sy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
          \PY{n}{ys} \PY{o}{=} \PY{l+m+mi}{0}
          \PY{n}{xe} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{ye} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
          \PY{n}{xs} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{ys} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
      \PY{k}{else}\PY{p}{:}
          \PY{n}{xe} \PY{o}{=} \PY{n}{sx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
          \PY{n}{xs} \PY{o}{=} \PY{l+m+mi}{0}
          \PY{n}{ye} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{xe} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
          \PY{n}{ys} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{xs} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}

      \PY{n}{ax1}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{markersize}\PY{o}{=}\PY{l+m+mi}{6}\PY{p}{,} \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZpc{}}\PY{k}{len}(colors)])
      \PY{n}{ax2}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{xs}\PY{p}{,} \PY{n}{xe}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{ys}\PY{p}{,} \PY{n}{ye}\PY{p}{]}\PY{p}{,} \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZpc{}}\PY{k}{len}(colors)])

      \PY{c+c1}{\PYZsh{} draw points}
      \PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{epipolarCorrespondence}\PY{p}{(}\PY{n}{I1}\PY{p}{,} \PY{n}{I2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{xc}\PY{p}{,} \PY{n}{yc}\PY{p}{)}
      \PY{n}{ax2}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x2}\PY{p}{,} \PY{n}{y2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{markersize}\PY{o}{=}\PY{l+m+mi}{8}\PY{p}{,} \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}
      \PY{n}{plt}\PY{o}{.}\PY{n}{draw}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{set-up-data}{%
\subsection{\texorpdfstring{\textbf{Set up
data}}{Set up data}}\label{set-up-data}}

In this section, we will download the test case image views, camera
intrinsics, and point correnspondences, which you will use for testing
your implementations.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{2}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{if} \PY{o+ow}{not} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{exists}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{:}
  \PY{o}{!}wget\PY{+w}{ }https://www.andrew.cmu.edu/user/eweng/data.zip\PY{+w}{ }\PYZhy{}O\PY{+w}{ }data.zip
  \PY{o}{!}unzip\PY{+w}{ }\PYZhy{}qq\PY{+w}{ }\PY{l+s+s2}{\PYZdq{}data.zip\PYZdq{}}
  \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{downloaded and unzipped data}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{problem-2-estimating-the-fundamental-matrix-with-the-eight-point-algorithm}{%
\section{Problem 2: Estimating the Fundamental Matrix with the
Eight-point
Algorithm}\label{problem-2-estimating-the-fundamental-matrix-with-the-eight-point-algorithm}}

    In this part, implement the 8-point algorithm you learned in class,
which estimates the fundamental matrix from corresponding points in two
images.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{3}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q2.1: Eight Point Algorithm}
\PY{l+s+sd}{  Input:  pts1, Nx2 Matrix}
\PY{l+s+sd}{          pts2, Nx2 Matrix}
\PY{l+s+sd}{          M, a scalar parameter computed as max(imwidth, imheight)}
\PY{l+s+sd}{  Output: F, the fundamental matrix}

\PY{l+s+sd}{  HINTS:}
\PY{l+s+sd}{  (1) Normalize the input pts1 and pts2 using the matrix T.}
\PY{l+s+sd}{  (2) Setup the eight point algorithm\PYZsq{}s equation.}
\PY{l+s+sd}{  (3) Solve for the least square solution using SVD.}
\PY{l+s+sd}{  (4) Use the function `\PYZus{}singularize` (provided in the helper functions above) to enforce the singularity condition.}
\PY{l+s+sd}{  (5) Use the function `refineF` (provided in the helper functions above) to refine the computed fundamental matrix.}
\PY{l+s+sd}{      (Remember to use the normalized points instead of the original points)}
\PY{l+s+sd}{  (6) Unscale the fundamental matrix by the lower right corner element}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}


  \PY{n}{F} \PY{o}{=} \PY{k+kc}{None}
  \PY{n}{N} \PY{o}{=} \PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}

  \PY{c+c1}{\PYZsh{} ===== your code here! =====}
  \PY{n}{T} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{M}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{o}{/}\PY{n}{M}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
  \PY{n}{pts1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{N}\PY{p}{)}\PY{p}{)}\PY{p}{)}
  \PY{n}{pts2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{vstack}\PY{p}{(}\PY{p}{(}\PY{n}{pts2}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{N}\PY{p}{)}\PY{p}{)}\PY{p}{)}
  \PY{n}{pts1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{T}\PY{p}{,}\PY{n}{pts1}\PY{p}{)}
  \PY{n}{pts2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{T}\PY{p}{,}\PY{n}{pts2}\PY{p}{)}

  \PY{n}{A} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,} \PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
  \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{N}\PY{p}{)}\PY{p}{:}
      \PY{n}{x1}\PY{p}{,} \PY{n}{y1} \PY{o}{=} \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{pts1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{i}\PY{p}{]}
      \PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{pts2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{i}\PY{p}{]}
      \PY{n}{A}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{[}\PY{n}{x2}\PY{o}{*}\PY{n}{x1}\PY{p}{,} \PY{n}{x2}\PY{o}{*}\PY{n}{y1}\PY{p}{,} \PY{n}{x2}\PY{p}{,} \PY{n}{y2}\PY{o}{*}\PY{n}{x1}\PY{p}{,} \PY{n}{y2}\PY{o}{*}\PY{n}{y1}\PY{p}{,} \PY{n}{y2}\PY{p}{,} \PY{n}{x1}\PY{p}{,} \PY{n}{y1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}

  \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{A}\PY{p}{)}
  \PY{n}{F} \PY{o}{=} \PY{n}{V}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}

  \PY{n}{F} \PY{o}{=} \PY{n}{\PYZus{}singularize}\PY{p}{(}\PY{n}{F}\PY{p}{)}
  \PY{n}{F} \PY{o}{=} \PY{n}{refineF}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{pts1}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{pts2}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{,} \PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{T}\PY{p}{)}  
  \PY{n}{F} \PY{o}{=} \PY{n}{T}\PY{o}{.}\PY{n}{T} \PY{o}{@} \PY{n}{F} \PY{o}{@} \PY{n}{T}
  \PY{n}{F} \PY{o}{=} \PY{n}{F} \PY{o}{/} \PY{n}{F}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}

  \PY{c+c1}{\PYZsh{} ==== end of code ====}

  \PY{k}{return} \PY{n}{F}
\end{Verbatim}
\end{tcolorbox}

    Run this code to test your implementation of the 8-point algorithm. Your
code should pass all the assert statements at the end.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{4}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+sa}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{recovered F:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+si}{\PYZob{}}\PY{n}{F}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{l+s+si}{\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Simple Tests to verify your implementation:}
\PY{n}{pts1\PYZus{}homogenous}\PY{p}{,} \PY{n}{pts2\PYZus{}homogenous} \PY{o}{=} \PY{n}{toHomogenous}\PY{p}{(}\PY{n}{pts1}\PY{p}{)}\PY{p}{,} \PY{n}{toHomogenous}\PY{p}{(}\PY{n}{pts2}\PY{p}{)}

\PY{k}{assert} \PY{n}{F}\PY{o}{.}\PY{n}{shape} \PY{o}{==} \PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{F is wrong shape}\PY{l+s+s2}{\PYZdq{}}
\PY{k}{assert} \PY{n}{F}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{F\PYZus{}33 != 1}\PY{l+s+s2}{\PYZdq{}}
\PY{k}{assert} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{F}\PY{p}{)} \PY{o}{==} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{F should have rank 2}\PY{l+s+s2}{\PYZdq{}}
\PY{k}{assert} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{calc\PYZus{}epi\PYZus{}error}\PY{p}{(}\PY{n}{pts1\PYZus{}homogenous}\PY{p}{,} \PY{n}{pts2\PYZus{}homogenous}\PY{p}{,} \PY{n}{F}\PY{p}{)}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{F error is too high to be accurate}\PY{l+s+s2}{\PYZdq{}}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
recovered F:
[[-0.      0.     -0.2519]
 [ 0.     -0.      0.0026]
 [ 0.2422 -0.0068  1.    ]]
    \end{Verbatim}

    The following tool may help you debug. You may specify a point in im1,
and view the corresponding epipolar line in im2 based on the F you
found. In your submission, make sure you include the debug picture
below, with at least five epipolar point-line correspondences taht show
that your calculation of F is correct.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{5}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} the points in im1, whose correnponding epipolar line in im2 you\PYZsq{}d like to verify}
\PY{n}{point} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{,}\PY{l+m+mi}{190}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{200}\PY{p}{,} \PY{l+m+mi}{200}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{400}\PY{p}{,}\PY{l+m+mi}{180}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{350}\PY{p}{,}\PY{l+m+mi}{350}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{520}\PY{p}{,} \PY{l+m+mi}{220}\PY{p}{)}\PY{p}{]}
\PY{c+c1}{\PYZsh{} feel free to change these point, to verify different point correspondences}
\PY{n}{displayEpipolarF}\PY{p}{(}\PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{point}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_18_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{problem-3-metric-reconstruction}{%
\section{Problem 3: Metric
Reconstruction}\label{problem-3-metric-reconstruction}}

    \hypertarget{essential-matrix}{%
\subsection{3.1 Essential Matrix}\label{essential-matrix}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{6}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{essentialMatrix}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{K1}\PY{p}{,} \PY{n}{K2}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q3.1: Compute the essential matrix E.}
\PY{l+s+sd}{    Input:  F, fundamental matrix}
\PY{l+s+sd}{            K1, internal camera calibration matrix of camera 1}
\PY{l+s+sd}{            K2, internal camera calibration matrix of camera 2}
\PY{l+s+sd}{    Output: E, the essential matrix}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} BEGIN SOLUTION}
  \PY{n}{E} \PY{o}{=} \PY{n}{K2}\PY{o}{.}\PY{n}{T} \PY{o}{@} \PY{n}{F} \PY{o}{@} \PY{n}{K1}
  \PY{n}{E} \PY{o}{=} \PY{n}{E} \PY{o}{/} \PY{n}{E}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} END SOLUTION}
  \PY{k}{return} \PY{n}{E}
\end{Verbatim}
\end{tcolorbox}

    Run the following code to check your implementation.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{7}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{E} \PY{o}{=} \PY{n}{essentialMatrix}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{K1}\PY{p}{,} \PY{n}{K2}\PY{p}{)}
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+sa}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{recovered E:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+si}{\PYZob{}}\PY{n}{E}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{l+s+si}{\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Simple Tests to verify your implementation:}
\PY{k}{assert}\PY{p}{(}\PY{n}{E}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{1}\PY{p}{)}
\PY{k}{assert}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{E}\PY{p}{)} \PY{o}{==} \PY{l+m+mi}{2}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
recovered E:
[[-3.3716000e+00  4.5661580e+02 -2.4738947e+03]
 [ 1.9760420e+02 -1.0290300e+01  6.4396600e+01]
 [ 2.4807427e+03  1.9856400e+01  1.0000000e+00]]
    \end{Verbatim}

    \hypertarget{triangulation}{%
\section{3.2 Triangulation}\label{triangulation}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{8}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{triangulate}\PY{p}{(}\PY{n}{C1}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q3.2: Triangulate a set of 2D coordinates in the image to a set of 3D points.}
\PY{l+s+sd}{  Input:  C1, the 3x4 camera matrix}
\PY{l+s+sd}{          pts1, the Nx2 matrix with the 2D image coordinates per row}
\PY{l+s+sd}{          C2, the 3x4 camera matrix}
\PY{l+s+sd}{          pts2, the Nx2 matrix with the 2D image coordinates per row}
\PY{l+s+sd}{  Output: P, the Nx3 matrix with the corresponding 3D points per row}
\PY{l+s+sd}{          err, the reprojection error.}

\PY{l+s+sd}{  Hints:}
\PY{l+s+sd}{  (1) For every input point, form A using the corresponding points from pts1 \PYZam{} pts2 and C1 \PYZam{} C2}
\PY{l+s+sd}{  (2) Solve for the least square solution using np.linalg.svd}
\PY{l+s+sd}{  (3) Calculate the reprojection error using the calculated 3D points and C1 \PYZam{} C2 (do not forget to convert from}
\PY{l+s+sd}{      homogeneous coordinates to non\PYZhy{}homogeneous ones)}
\PY{l+s+sd}{  (4) Keep track of the 3D points and projection error, and continue to next point}
\PY{l+s+sd}{  (5) You do not need to follow the exact procedure above.}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} BEGIN SOLUTION}
  \PY{n}{N} \PY{o}{=} \PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
  \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
  \PY{n}{err} \PY{o}{=} \PY{l+m+mi}{0}
  \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{N}\PY{p}{)}\PY{p}{:}
    \PY{n}{x1}\PY{p}{,} \PY{n}{y1} \PY{o}{=} \PY{n}{pts1}\PY{p}{[}\PY{n}{i}\PY{p}{]}
    \PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{pts2}\PY{p}{[}\PY{n}{i}\PY{p}{]}
    \PY{n}{A} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{y1}\PY{o}{*}\PY{n}{C1}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{C1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} 
                  \PY{n}{C1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{x1}\PY{o}{*}\PY{n}{C1}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} 
                  \PY{n}{y2}\PY{o}{*}\PY{n}{C2}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{C2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} 
                  \PY{n}{C2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{x2}\PY{o}{*}\PY{n}{C2}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{A}\PY{p}{)}
    \PY{n}{P}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{V}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]} \PY{o}{/} \PY{n}{V}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{]}
    \PY{n}{P1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{P}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
    \PY{n}{xp1} \PY{o}{=} \PY{n}{C1} \PY{o}{@} \PY{n}{P1}
    \PY{n}{xp2} \PY{o}{=} \PY{n}{C2} \PY{o}{@} \PY{n}{P1}
    \PY{n}{xp1} \PY{o}{=} \PY{n}{xp1}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{/} \PY{n}{xp1}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}
    \PY{n}{xp2} \PY{o}{=} \PY{n}{xp2}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{/} \PY{n}{xp2}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}
    \PY{n}{err} \PY{o}{+}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{xp1} \PY{o}{\PYZhy{}} \PY{n}{pts1}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{xp2} \PY{o}{\PYZhy{}} \PY{n}{pts2}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} END SOLUTION}
  
  \PY{k}{return} \PY{n}{P}\PY{p}{,} \PY{n}{err}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{find-m2}{%
\subsection{3.3 Find M2}\label{find-m2}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{9}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{camera2}\PY{p}{(}\PY{n}{E}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}helper function to find the 4 possibile M2 matrices\PYZdq{}\PYZdq{}\PYZdq{}}
  \PY{n}{U}\PY{p}{,}\PY{n}{S}\PY{p}{,}\PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{E}\PY{p}{)}
  \PY{n}{m} \PY{o}{=} \PY{n}{S}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}
  \PY{n}{E} \PY{o}{=} \PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{m}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{m}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}
  \PY{n}{U}\PY{p}{,}\PY{n}{S}\PY{p}{,}\PY{n}{V} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{E}\PY{p}{)}
  \PY{n}{W} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}

  \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{det}\PY{p}{(}\PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{)}\PY{o}{\PYZlt{}}\PY{l+m+mi}{0}\PY{p}{:}
      \PY{n}{W} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{W}

  \PY{n}{M2s} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}
  \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{,} \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n+nb}{abs}\PY{p}{(}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n+nb}{abs}\PY{p}{(}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{,} \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n+nb}{abs}\PY{p}{(}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{U}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{W}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{V}\PY{p}{)}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n+nb}{abs}\PY{p}{(}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{k}{return} \PY{n}{M2s}


\PY{k}{def} \PY{n+nf}{findM2}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{)}\PY{p}{:}
\PY{+w}{    }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    Q3.3: Function to find camera2\PYZsq{}s projective matrix given correspondences}
\PY{l+s+sd}{        Input:  F, the pre\PYZhy{}computed fundamental matrix}
\PY{l+s+sd}{                pts1, the Nx2 matrix with the 2D image coordinates per row}
\PY{l+s+sd}{                pts2, the Nx2 matrix with the 2D image coordinates per row}
\PY{l+s+sd}{                intrinsics, the intrinsics of the cameras, load from the .npz file}
\PY{l+s+sd}{                filename, the filename to store results}
\PY{l+s+sd}{        Output: [M2, C2, P] the computed M2 (3x4) camera projective matrix, C2 (3x4) K2 * M2, and the 3D points P (Nx3)}

\PY{l+s+sd}{    ***}
\PY{l+s+sd}{    Hints:}
\PY{l+s+sd}{    (1) Loop through the \PYZsq{}M2s\PYZsq{} and use triangulate to calculate the 3D points and projection error. Keep track}
\PY{l+s+sd}{        of the projection error through best\PYZus{}error and retain the best one.}
\PY{l+s+sd}{    (2) Remember to take a look at camera2 to see how to correctly reterive the M2 matrix from \PYZsq{}M2s\PYZsq{}.}

\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}

    \PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}

    \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
    \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} BEGIN SOLUTION}
    \PY{n}{E} \PY{o}{=} \PY{n}{essentialMatrix}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{K1}\PY{p}{,} \PY{n}{K2}\PY{p}{)}
    \PY{n}{M1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{)}
    \PY{n}{M2s} \PY{o}{=} \PY{n}{camera2}\PY{p}{(}\PY{n}{E}\PY{p}{)}
    \PY{n}{C1} \PY{o}{=} \PY{n}{K1} \PY{o}{@} \PY{n}{M1}
    \PY{n}{M2}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{P} \PY{o}{=} \PY{k+kc}{None}\PY{p}{,} \PY{k+kc}{None}\PY{p}{,} \PY{k+kc}{None}

    \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{M2s}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{p}{:}
        \PY{n}{C2} \PY{o}{=} \PY{n}{K2} \PY{o}{@} \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{n}{i}\PY{p}{]}
        \PY{n}{P\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{triangulate}\PY{p}{(}\PY{n}{C1}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}
        \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{min}\PY{p}{(}\PY{n}{P\PYZus{}}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
            \PY{n}{M2} \PY{o}{=} \PY{n}{M2s}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{n}{i}\PY{p}{]}
            \PY{n}{P} \PY{o}{=} \PY{n}{P\PYZus{}}

    \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} END SOLUTION}

    \PY{k}{return} \PY{n}{M2}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{P}
\end{Verbatim}
\end{tcolorbox}

    Run the following code to check your implementation of triangulation and
findM2.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{10}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}\PY{p}{)}

\PY{n}{M2}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{P} \PY{o}{=} \PY{n}{findM2}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Simple Tests to verify your implementation:}
\PY{n}{M1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{identity}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{C1} \PY{o}{=} \PY{n}{K1}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{M1}\PY{p}{)}
\PY{n}{C2} \PY{o}{=} \PY{n}{K2}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{M2}\PY{p}{)}
\PY{n}{P\PYZus{}test}\PY{p}{,} \PY{n}{err} \PY{o}{=} \PY{n}{triangulate}\PY{p}{(}\PY{n}{C1}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}
\PY{k}{assert}\PY{p}{(}\PY{n}{err} \PY{o}{\PYZlt{}} \PY{l+m+mi}{500}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{problem-4-3d-visualization}{%
\section{Problem 4: 3D Visualization}\label{problem-4-3d-visualization}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{11}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{epipolarCorrespondence}\PY{p}{(}\PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{x1}\PY{p}{,} \PY{n}{y1}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q4.1: 3D visualization of the temple images.}
\PY{l+s+sd}{  Input:  im1, the first image}
\PY{l+s+sd}{          im2, the second image}
\PY{l+s+sd}{          F, the fundamental matrix}
\PY{l+s+sd}{          x1, x\PYZhy{}coordinates of a pixel on im1}
\PY{l+s+sd}{          y1, y\PYZhy{}coordinates of a pixel on im1}
\PY{l+s+sd}{  Output: x2, x\PYZhy{}coordinates of the pixel on im2}
\PY{l+s+sd}{          y2, y\PYZhy{}coordinates of the pixel on im2}

\PY{l+s+sd}{  Hints:}
\PY{l+s+sd}{  (1) Given input [x1, x2], use the fundamental matrix to recover the corresponding epipolar line on image2}
\PY{l+s+sd}{  (2) Search along this line to check nearby pixel intensity (you can define a search window) to}
\PY{l+s+sd}{      find the best matches}
\PY{l+s+sd}{  (3) Use gaussian weighting to weight the pixel simlairty}

\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}
  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{} YOUR CODE HERE}
  \PY{n}{window} \PY{o}{=} \PY{l+m+mi}{5} 
  \PY{n}{segment} \PY{o}{=} \PY{n}{im1}\PY{p}{[}\PY{n}{y1}\PY{o}{\PYZhy{}}\PY{n}{window}\PY{p}{:}\PY{n}{y1}\PY{o}{+}\PY{n}{window}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} 
                \PY{n}{x1}\PY{o}{\PYZhy{}}\PY{n}{window}\PY{p}{:}\PY{n}{x1}\PY{o}{+}\PY{n}{window}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{p}{:}\PY{p}{]}
  \PY{c+c1}{\PYZsh{} epipolar line}
  \PY{n}{l} \PY{o}{=} \PY{n}{F} \PY{o}{@} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{x1}\PY{p}{,} \PY{n}{y1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
  \PY{n}{best\PYZus{}pt} \PY{o}{=} \PY{k+kc}{None}
  \PY{n}{best\PYZus{}dist} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{inf}
  \PY{c+c1}{\PYZsh{} gaussian kernel}
  \PY{n}{sigma} \PY{o}{=} \PY{l+m+mi}{1}
  \PY{n}{x} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{window}\PY{p}{,} \PY{n}{window}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{y} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{window}\PY{p}{,} \PY{n}{window}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{xx}\PY{p}{,} \PY{n}{yy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{meshgrid}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{)}
  \PY{n}{kernel} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{xx}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{yy}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{sigma}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
  \PY{n}{kernel} \PY{o}{=} \PY{n}{kernel} \PY{o}{/} \PY{n}{kernel}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}

  \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
    \PY{n}{x} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{l}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{i} \PY{o}{+} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{n}{l}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
    \PY{n}{xl}\PY{p}{,} \PY{n}{xh} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{floor}\PY{p}{(}\PY{n}{x} \PY{o}{\PYZhy{}} \PY{n}{window}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{floor}\PY{p}{(}\PY{n}{x} \PY{o}{+} \PY{n}{window} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{yl}\PY{p}{,} \PY{n}{yh} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{floor}\PY{p}{(}\PY{n}{i} \PY{o}{\PYZhy{}} \PY{n}{window}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{floor}\PY{p}{(}\PY{n}{i} \PY{o}{+} \PY{n}{window} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}

    \PY{k}{if} \PY{p}{(}\PY{n}{xl} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{)} \PY{o+ow}{or} \PY{p}{(}\PY{n}{yl} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{)} \PY{o+ow}{or} \PY{p}{(}\PY{n}{xh} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o+ow}{or} \PY{p}{(}\PY{n}{yh} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
        \PY{k}{continue}
    \PY{n}{segment2} \PY{o}{=} \PY{n}{im2}\PY{p}{[}\PY{n+nb}{int}\PY{p}{(}\PY{n}{yl}\PY{p}{)}\PY{p}{:}\PY{n+nb}{int}\PY{p}{(}\PY{n}{yh}\PY{p}{)}\PY{p}{,} \PY{n+nb}{int}\PY{p}{(}\PY{n}{xl}\PY{p}{)}\PY{p}{:}\PY{n+nb}{int}\PY{p}{(}\PY{n}{xh}\PY{p}{)}\PY{p}{,}\PY{p}{:}\PY{p}{]}
    \PY{n}{dist} \PY{o}{=} \PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{segment} \PY{o}{\PYZhy{}} \PY{n}{segment2}\PY{p}{)}\PY{o}{*}\PY{n}{kernel}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}

    \PY{k}{if} \PY{n}{dist} \PY{o}{\PYZlt{}} \PY{n}{best\PYZus{}dist}\PY{p}{:}
        \PY{n}{best\PYZus{}dist} \PY{o}{=} \PY{n}{dist}
        \PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{x}\PY{p}{,} \PY{n}{i}
   
  \PY{c+c1}{\PYZsh{} END YOUR CODE}
  \PY{k}{return} \PY{n}{x2}\PY{p}{,} \PY{n}{y2}
\end{Verbatim}
\end{tcolorbox}

    Run the following code to check your implementation.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{12}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Simple Tests to verify your implementation:}
\PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{epipolarCorrespondence}\PY{p}{(}\PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{,} \PY{l+m+mi}{217}\PY{p}{)}
\PY{k}{assert}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{x2}\PY{p}{,} \PY{n}{y2}\PY{p}{]}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{118}\PY{p}{,} \PY{l+m+mi}{181}\PY{p}{]}\PY{p}{)}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mi}{10}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    Use the below tool to debug your code.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{13}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} the points in im1 whose correnponding epipolar line in im2 you\PYZsq{}d like to verify}
\PY{n}{points} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{,}\PY{l+m+mi}{190}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{200}\PY{p}{,} \PY{l+m+mi}{200}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{400}\PY{p}{,}\PY{l+m+mi}{180}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{350}\PY{p}{,}\PY{l+m+mi}{350}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{520}\PY{p}{,} \PY{l+m+mi}{220}\PY{p}{)}\PY{p}{]}
\PY{c+c1}{\PYZsh{} feel free to change these points to verify different point correspondences}
\PY{n}{epipolarMatchGUI}\PY{p}{(}\PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{points}\PY{p}{,} \PY{n}{epipolarCorrespondence}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_35_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{temple-visualization}{%
\subsection{4.2 Temple Visualization}\label{temple-visualization}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{14}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{compute3D\PYZus{}pts}\PY{p}{(}\PY{n}{temple\PYZus{}pts1}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q4.2: Finding the 3D position of given points based on epipolar correspondence and triangulation}
\PY{l+s+sd}{  Input:  temple\PYZus{}pts1, chosen points from im1}
\PY{l+s+sd}{          intrinsics, the intrinsics dictionary for calling epipolarCorrespondence}
\PY{l+s+sd}{          F, the fundamental matrix}
\PY{l+s+sd}{          im1, the first image}
\PY{l+s+sd}{          im2, the second image}
\PY{l+s+sd}{  Output: P (Nx3) the recovered 3D points}

\PY{l+s+sd}{  Hints:}
\PY{l+s+sd}{  (1) Use epipolarCorrespondence to find the corresponding point for [x1 y1] (find [x2, y2])}
\PY{l+s+sd}{  (2) Now you have a set of corresponding points [x1, y1] and [x2, y2], you can compute the M2}
\PY{l+s+sd}{      matrix and use triangulate to find the 3D points.}
\PY{l+s+sd}{  (3) Use the function findM2 to find the 3D points P (do not recalculate fundamental matrices)}
\PY{l+s+sd}{  (4) As a reference, our solution\PYZsq{}s best error is around \PYZti{}2200 on the 3D points.}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}
  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{} YOUR CODE HERE}
  \PY{n}{temple\PYZus{}pts2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{temple\PYZus{}pts1}\PY{p}{)}
  \PY{k}{for} \PY{n}{i}\PY{p}{,} \PY{p}{(}\PY{n}{x1}\PY{p}{,} \PY{n}{y1}\PY{p}{)} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{temple\PYZus{}pts1}\PY{p}{)}\PY{p}{:}
      \PY{n}{x2}\PY{p}{,} \PY{n}{y2} \PY{o}{=} \PY{n}{epipolarCorrespondence}\PY{p}{(}\PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{x1}\PY{p}{,} \PY{n}{y1}\PY{p}{)}
      \PY{n}{temple\PYZus{}pts2}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{[}\PY{n}{x2}\PY{p}{,} \PY{n}{y2}\PY{p}{]}
  \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{P} \PY{o}{=} \PY{n}{findM2}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{temple\PYZus{}pts1}\PY{p}{,} \PY{n}{temple\PYZus{}pts2}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{)}

  \PY{k}{return} \PY{n}{P}
  \PY{c+c1}{\PYZsh{} END YOUR CODE}
\end{Verbatim}
\end{tcolorbox}

    Below, integrate everything together. The provided starter code loads in
the temple data found at \texttt{data/templeCoords.npz}, which contains
288 hand-selected points from im1 saved in the variables x1 and y1.
Then, get the 3d points from the 2d point point correspondences by
calling the function you just implemented, as well as other necessary
function. Finally, visualize the 3D reconstruction using matplotlib or
plotly 3d scatter plot.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{15}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{temple\PYZus{}coords} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/templeCoords.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading temple coordinates}
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
\PY{c+c1}{\PYZsh{} Call eightpoint to get the F matrix}
\PY{c+c1}{\PYZsh{} Call compute3D\PYZus{}pts to get the 3D points and visualize using matplotlib scatter}
\PY{c+c1}{\PYZsh{} hint: you can change the viewpoint of a matplotlib 3d axes using}
\PY{c+c1}{\PYZsh{} `ax.view\PYZus{}init(azim, elev)` where azim is the rotation around the vertical z}
\PY{c+c1}{\PYZsh{} axis, and elev is the angle of elevation from the x\PYZhy{}y plane}

\PY{n}{temple\PYZus{}pts1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{temple\PYZus{}coords}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{x1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{temple\PYZus{}coords}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{y1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]}\PY{p}{)}

\PY{c+c1}{\PYZsh{} YOUR CODE HERE}
\PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{P} \PY{o}{=} \PY{n}{compute3D\PYZus{}pts}\PY{p}{(}\PY{n}{temple\PYZus{}pts1}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{,} \PY{n}{F}\PY{p}{,} \PY{n}{im1}\PY{p}{,} \PY{n}{im2}\PY{p}{)}
\PY{c+c1}{\PYZsh{} END YOUR CODE}

\PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
\PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{ax}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{s}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{c}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{depthshade}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{draw}\PY{p}{(}\PY{p}{)}

\PY{c+c1}{\PYZsh{} also show a different viewpoint}
\PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
\PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{ax}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{s}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{c}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{depthshade}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax}\PY{o}{.}\PY{n}{view\PYZus{}init}\PY{p}{(}\PY{l+m+mi}{30}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{draw}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_39_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_39_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{problem-5-bundle-adjustment}{%
\section{Problem 5: Bundle
Adjustment}\label{problem-5-bundle-adjustment}}

    Below is the implementation of RANSAC for Fundamental Matrix Recovery.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{16}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{ransacF}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{p}{,} \PY{n}{nIters}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{tol}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Input:  pts1, Nx2 Matrix}
\PY{l+s+sd}{          pts2, Nx2 Matrix}
\PY{l+s+sd}{          M, a scaler parameter}
\PY{l+s+sd}{          nIters, Number of iterations of the Ransac}
\PY{l+s+sd}{          tol, tolerence for inliers}
\PY{l+s+sd}{  Output: F, the fundamental matrix}
\PY{l+s+sd}{          inliers, Nx1 bool vector set to true for inliers}

\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}
  \PY{n}{N} \PY{o}{=} \PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
  \PY{n}{pts1\PYZus{}homo}\PY{p}{,} \PY{n}{pts2\PYZus{}homo} \PY{o}{=} \PY{n}{toHomogenous}\PY{p}{(}\PY{n}{pts1}\PY{p}{)}\PY{p}{,} \PY{n}{toHomogenous}\PY{p}{(}\PY{n}{pts2}\PY{p}{)}
  \PY{n}{best\PYZus{}inlier} \PY{o}{=} \PY{l+m+mi}{0}
  \PY{n}{inlier\PYZus{}curr} \PY{o}{=} \PY{k+kc}{None}

  \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{nIters}\PY{p}{)}\PY{p}{:}
      \PY{n}{choice} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{choice}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{pts1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}
      \PY{n}{pts1\PYZus{}choice} \PY{o}{=} \PY{n}{pts1}\PY{p}{[}\PY{n}{choice}\PY{p}{,} \PY{p}{:}\PY{p}{]}
      \PY{n}{pts2\PYZus{}choice} \PY{o}{=} \PY{n}{pts2}\PY{p}{[}\PY{n}{choice}\PY{p}{,} \PY{p}{:}\PY{p}{]}
      \PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1\PYZus{}choice}\PY{p}{,} \PY{n}{pts2\PYZus{}choice}\PY{p}{,} \PY{n}{M}\PY{p}{)}
      \PY{n}{ress} \PY{o}{=} \PY{n}{calc\PYZus{}epi\PYZus{}error}\PY{p}{(}\PY{n}{pts1\PYZus{}homo}\PY{p}{,} \PY{n}{pts2\PYZus{}homo}\PY{p}{,} \PY{n}{F}\PY{p}{)}
      \PY{n}{curr\PYZus{}num\PYZus{}inliner} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{ress} \PY{o}{\PYZlt{}} \PY{n}{tol}\PY{p}{)}
      \PY{k}{if} \PY{n}{curr\PYZus{}num\PYZus{}inliner} \PY{o}{\PYZgt{}} \PY{n}{best\PYZus{}inlier}\PY{p}{:}
          \PY{n}{F\PYZus{}curr} \PY{o}{=} \PY{n}{F}
          \PY{n}{inlier\PYZus{}curr} \PY{o}{=} \PY{p}{(}\PY{n}{ress} \PY{o}{\PYZlt{}} \PY{n}{tol}\PY{p}{)}
          \PY{n}{best\PYZus{}inlier} \PY{o}{=} \PY{n}{curr\PYZus{}num\PYZus{}inliner}
  \PY{n}{inlier\PYZus{}curr} \PY{o}{=} \PY{n}{inlier\PYZus{}curr}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{n}{inlier\PYZus{}curr}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
  \PY{n}{indixing\PYZus{}array} \PY{o}{=} \PY{n}{inlier\PYZus{}curr}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}
  \PY{n}{pts1\PYZus{}inlier} \PY{o}{=} \PY{n}{pts1}\PY{p}{[}\PY{n}{indixing\PYZus{}array}\PY{p}{]}
  \PY{n}{pts2\PYZus{}inlier} \PY{o}{=} \PY{n}{pts2}\PY{p}{[}\PY{n}{indixing\PYZus{}array}\PY{p}{]}
  \PY{n}{F} \PY{o}{=} \PY{n}{eightpoint}\PY{p}{(}\PY{n}{pts1\PYZus{}inlier}\PY{p}{,} \PY{n}{pts2\PYZus{}inlier}\PY{p}{,} \PY{n}{M}\PY{p}{)}
  \PY{k}{return} \PY{n}{F}\PY{p}{,} \PY{n}{inlier\PYZus{}curr}
\end{Verbatim}
\end{tcolorbox}

    Below is the implementation of Rodrigues and Inverse Rodrigues Formulas.
See the pdf for the detailed explanation of the functions.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{17}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{rodrigues}\PY{p}{(}\PY{n}{r}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{      Input:  r, a 3x1 vector}
\PY{l+s+sd}{      Output: R, a rotation matrix}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{n}{r} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{r}\PY{p}{)}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}
  \PY{n}{I} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}
  \PY{n}{theta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{r}\PY{p}{)}
  \PY{k}{if} \PY{n}{theta} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
      \PY{k}{return} \PY{n}{I}
  \PY{k}{else}\PY{p}{:}
      \PY{n}{U} \PY{o}{=} \PY{p}{(}\PY{n}{r}\PY{o}{/}\PY{n}{theta}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}
      \PY{n}{Ux}\PY{p}{,} \PY{n}{Uy}\PY{p}{,} \PY{n}{Uz} \PY{o}{=} \PY{n}{r}\PY{o}{/}\PY{n}{theta}
      \PY{n}{K} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{Uz}\PY{p}{,} \PY{n}{Uy}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{Uz}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{Ux}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{Uy}\PY{p}{,} \PY{n}{Ux}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
      \PY{n}{R} \PY{o}{=} \PY{n}{I} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)} \PY{o}{*} \PY{n}{K} \PY{o}{+} \PYZbs{}
          \PY{p}{(}\PY{l+m+mi}{1} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{)} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{matmul}\PY{p}{(}\PY{n}{U}\PY{p}{,} \PY{n}{U}\PY{o}{.}\PY{n}{T}\PY{p}{)}
  \PY{k}{return} \PY{n}{R}


\PY{k}{def} \PY{n+nf}{invRodrigues}\PY{p}{(}\PY{n}{R}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Input:  R, a rotation matrix}
\PY{l+s+sd}{  Output: r, a 3x1 vector}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{k}{def} \PY{n+nf}{s\PYZus{}half}\PY{p}{(}\PY{n}{r}\PY{p}{)}\PY{p}{:}
      \PY{n}{r1}\PY{p}{,} \PY{n}{r2}\PY{p}{,} \PY{n}{r3} \PY{o}{=} \PY{n}{r}
      \PY{k}{if} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{r}\PY{p}{)} \PY{o}{==} \PY{n}{np}\PY{o}{.}\PY{n}{pi} \PY{o+ow}{and} \PY{p}{(}\PY{n}{r1} \PY{o}{==} \PY{n}{r2} \PY{o+ow}{and} \PY{n}{r1} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{r2} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{r3} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{)} \PY{o+ow}{or} \PY{p}{(}\PY{n}{r1} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{r2} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{)} \PY{o+ow}{or} \PY{p}{(}\PY{n}{r1} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{:}
          \PY{k}{return} \PY{o}{\PYZhy{}}\PY{n}{r}
      \PY{k}{else}\PY{p}{:}
          \PY{k}{return} \PY{n}{r}

  \PY{n}{A} \PY{o}{=} \PY{p}{(}\PY{n}{R} \PY{o}{\PYZhy{}} \PY{n}{R}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}
  \PY{n}{ro} \PY{o}{=} \PY{p}{[}\PY{n}{A}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{A}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
  \PY{n}{s} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{ro}\PY{p}{)}
  \PY{n}{c} \PY{o}{=} \PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{matrix}\PY{p}{(}\PY{n}{R}\PY{p}{)}\PY{o}{.}\PY{n}{diagonal}\PY{p}{(}\PY{p}{)}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}
  \PY{k}{if} \PY{n}{s} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{c} \PY{o}{==} \PY{l+m+mi}{1}\PY{p}{:}
      \PY{n}{r} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}
  \PY{k}{elif} \PY{n}{s} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{and} \PY{n}{c} \PY{o}{==} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
      \PY{n}{col} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{eye}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)} \PY{o}{+} \PY{n}{R}
      \PY{n}{col\PYZus{}idx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{nonzero}\PY{p}{(}
          \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{col} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
      \PY{n}{v} \PY{o}{=} \PY{n}{col}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{col\PYZus{}idx}\PY{p}{]}
      \PY{n}{u} \PY{o}{=} \PY{n}{v}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{v}\PY{p}{)}
      \PY{n}{r} \PY{o}{=} \PY{n}{s\PYZus{}half}\PY{p}{(}\PY{n}{u} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{)}
  \PY{k}{else}\PY{p}{:}
      \PY{n}{u} \PY{o}{=} \PY{n}{ro}\PY{o}{/}\PY{n}{s}
      \PY{n}{theta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arctan2}\PY{p}{(}\PY{n}{s}\PY{p}{,} \PY{n}{c}\PY{p}{)}
      \PY{n}{r} \PY{o}{=} \PY{n}{u} \PY{o}{*} \PY{n}{theta}

  \PY{k}{return} \PY{n}{r}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{rodrigues-residual-objective-function}{%
\subsubsection{Rodrigues Residual objective
function}\label{rodrigues-residual-objective-function}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{18}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{rodriguesResidual}\PY{p}{(}\PY{n}{K1}\PY{p}{,} \PY{n}{M1}\PY{p}{,} \PY{n}{p1}\PY{p}{,} \PY{n}{K2}\PY{p}{,} \PY{n}{p2}\PY{p}{,} \PY{n}{x}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q5.1: Rodrigues residual.}
\PY{l+s+sd}{    Input:  K1, the intrinsics of camera 1}
\PY{l+s+sd}{            M1, the extrinsics of camera 1}
\PY{l+s+sd}{            p1, the 2D coordinates of points in image 1}
\PY{l+s+sd}{            K2, the intrinsics of camera 2}
\PY{l+s+sd}{            p2, the 2D coordinates of points in image 2}
\PY{l+s+sd}{            x, the flattened concatenationg of P, r2, and t2.}
\PY{l+s+sd}{    Output: residuals, 4N x 1 vector, the difference between original and estimated projections}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}
  \PY{n}{N} \PY{o}{=} \PY{n}{p1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} BEGIN SOLUTION}
  \PY{n}{P} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{N}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{n}{N}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}
  \PY{n}{r2} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{N}\PY{p}{:}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{N}\PY{o}{+}\PY{l+m+mi}{3}\PY{p}{]}
  \PY{n}{t2} \PY{o}{=} \PY{n}{x}\PY{p}{[}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{N}\PY{o}{+}\PY{l+m+mi}{3}\PY{p}{:}\PY{p}{]}

  \PY{n}{Ph} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{P}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{N}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{]}\PY{p}{)}
  \PY{n}{C1} \PY{o}{=} \PY{n}{K1} \PY{o}{@} \PY{n}{M1}
  \PY{n}{C2} \PY{o}{=} \PY{n}{K2} \PY{o}{@} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{rodrigues}\PY{p}{(}\PY{n}{r2}\PY{p}{)}\PY{p}{,} \PY{n}{t2}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{]}\PY{p}{)}
  \PY{n}{p1\PYZus{}est} \PY{o}{=} \PY{n}{Ph} \PY{o}{@} \PY{n}{C1}\PY{o}{.}\PY{n}{T}
  \PY{n}{p2\PYZus{}est} \PY{o}{=} \PY{n}{Ph} \PY{o}{@} \PY{n}{C2}\PY{o}{.}\PY{n}{T}
  \PY{n}{p1\PYZus{}est} \PY{o}{=} \PY{n}{p1\PYZus{}est}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{/} \PY{n}{p1\PYZus{}est}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{:}\PY{p}{]}
  \PY{n}{p2\PYZus{}est} \PY{o}{=} \PY{n}{p2\PYZus{}est}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{o}{/} \PY{n}{p2\PYZus{}est}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{:}\PY{p}{]}
  \PY{n}{residuals} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{p1}\PY{o}{\PYZhy{}}\PY{n}{p1\PYZus{}est}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{p2}\PY{o}{\PYZhy{}}\PY{n}{p2\PYZus{}est}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{)}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} END SOLUTION}
  \PY{k}{return} \PY{n}{residuals}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{bundle-adjustment}{%
\subsubsection{Bundle Adjustment}\label{bundle-adjustment}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{19}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{bundleAdjustment}\PY{p}{(}\PY{n}{K1}\PY{p}{,} \PY{n}{M1}\PY{p}{,} \PY{n}{p1}\PY{p}{,} \PY{n}{K2}\PY{p}{,} \PY{n}{M2\PYZus{}init}\PY{p}{,} \PY{n}{p2}\PY{p}{,} \PY{n}{P\PYZus{}init}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q5.2 Bundle adjustment.}
\PY{l+s+sd}{  Input:  K1, the intrinsics of camera 1}
\PY{l+s+sd}{          M1, the extrinsics of camera 1}
\PY{l+s+sd}{          p1, the 2D coordinates of points in image 1}
\PY{l+s+sd}{          K2,  the intrinsics of camera 2}
\PY{l+s+sd}{          M2\PYZus{}init, the initial extrinsics of camera 1}
\PY{l+s+sd}{          p2, the 2D coordinates of points in image 2}
\PY{l+s+sd}{          P\PYZus{}init, the initial 3D coordinates of points}
\PY{l+s+sd}{  Output: M2, the optimized extrinsics of camera 1}
\PY{l+s+sd}{          P2, the optimized 3D coordinates of points}
\PY{l+s+sd}{          o1, the starting objective function value with the initial input}
\PY{l+s+sd}{          o2, the ending objective function value after bundle adjustment}

\PY{l+s+sd}{  Hints:}
\PY{l+s+sd}{  (1) Use the scipy.optimize.minimize function to minimize the objective function, rodriguesResidual.}
\PY{l+s+sd}{      You can try different (method=\PYZsq{}..\PYZsq{}) in scipy.optimize.minimize for best results.}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}
  \PY{n}{obj\PYZus{}start} \PY{o}{=} \PY{n}{obj\PYZus{}end} \PY{o}{=} \PY{l+m+mi}{0}
  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} BEGIN SOLUTION}
  \PY{c+c1}{\PYZsh{} x0 = np.concatenate([P\PYZus{}init.flatten(), invRodrigues(M2\PYZus{}init[:, :3]).flatten(), M2\PYZus{}init[:, 3]])}
  \PY{n}{x0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{invRodrigues}\PY{p}{(}\PY{n}{M2\PYZus{}init}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{M2\PYZus{}init}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{]}\PY{p}{]}\PY{p}{)}
  \PY{n}{f} \PY{o}{=} \PY{k}{lambda} \PY{n}{x}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{(}\PY{n}{rodriguesResidual}\PY{p}{(}\PY{n}{K1}\PY{p}{,} \PY{n}{M1}\PY{p}{,} \PY{n}{p1}\PY{p}{,} \PY{n}{K2}\PY{p}{,} \PY{n}{p2}\PY{p}{,} \PY{n}{x}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
  \PY{n}{obj\PYZus{}start} \PY{o}{=} \PY{n}{f}\PY{p}{(}\PY{n}{x0}\PY{p}{)}

  \PY{n}{res} \PY{o}{=} \PY{n}{scipy}\PY{o}{.}\PY{n}{optimize}\PY{o}{.}\PY{n}{minimize}\PY{p}{(}\PY{n}{f}\PY{p}{,} \PY{n}{x0}\PY{p}{,} \PY{n}{method}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Powell}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  
  \PY{n}{P} \PY{o}{=} \PY{n}{res}\PY{o}{.}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
  \PY{n}{r2} \PY{o}{=} \PY{n}{res}\PY{o}{.}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{:}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{3}\PY{p}{]}
  \PY{n}{t2} \PY{o}{=} \PY{n}{res}\PY{o}{.}\PY{n}{x}\PY{p}{[}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{P\PYZus{}init}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{3}\PY{p}{:}\PY{p}{]}
  \PY{n}{M2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{[}\PY{n}{rodrigues}\PY{p}{(}\PY{n}{r2}\PY{p}{)}\PY{p}{,} \PY{n}{t2}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{]}\PY{p}{)}

  \PY{n}{obj\PYZus{}end} \PY{o}{=} \PY{n}{f}\PY{p}{(}\PY{n}{res}\PY{o}{.}\PY{n}{x}\PY{p}{)}
  \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} END SOLUTION}
  \PY{k}{return} \PY{n}{M2}\PY{p}{,} \PY{n}{P}\PY{p}{,} \PY{n}{obj\PYZus{}start}\PY{p}{,} \PY{n}{obj\PYZus{}end}
\end{Verbatim}
\end{tcolorbox}

    Put it all together

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Call the ransacF function to find the fundamental matrix
\item
  Call the findM2 function to find the extrinsics of the second camera
\item
  Call the bundleAdjustment function to optimize the extrinsics and 3D
  points
\item
  Plot the 3D points before and after bundle adjustment using the
  plot\_3D\_dual function
\end{enumerate}

On the given temple data, bundle adjustment can take up to 2 min to run.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{20}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} Visualization:}
\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{seed}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
\PY{n}{correspondence} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/some\PYZus{}corresp\PYZus{}noisy.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading noisy correspondences}
\PY{n}{intrinsics} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/intrinsics.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} Loading the intrinscis of the camera}
\PY{n}{K1}\PY{p}{,} \PY{n}{K2} \PY{o}{=} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2} \PY{o}{=} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{correspondence}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im1.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/im2.png}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{M}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{[}\PY{o}{*}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{o}{*}\PY{n}{im2}\PY{o}{.}\PY{n}{shape}\PY{p}{]}\PY{p}{)}

\PY{c+c1}{\PYZsh{} YOUR CODE HERE}
\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{Call the ransacF function to find the fundamental matrix}
\PY{l+s+sd}{Call the findM2 function to find the extrinsics of the second camera}
\PY{l+s+sd}{Call the bundleAdjustment function to optimize the extrinsics and 3D points}
\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{c+c1}{\PYZsh{} YOUR CODE HERE}
\PY{c+c1}{\PYZsh{} F, inliers = ransacF(pts1, pts2, M)}
\PY{c+c1}{\PYZsh{} pts1\PYZus{}inliers = pts1[inliers.flatten()]}
\PY{c+c1}{\PYZsh{} pts2\PYZus{}inliers = pts2[inliers.flatten()]}
\PY{c+c1}{\PYZsh{} M2, C2, P = findM2(F, pts1, pts2, intrinsics)}
\PY{c+c1}{\PYZsh{} M1 = np.hstack((np.identity(3), np.zeros(3)[:,np.newaxis]))}
\PY{c+c1}{\PYZsh{} M2\PYZus{}opt, P\PYZus{}opt, obj\PYZus{}start, obj\PYZus{}end = bundleAdjustment(K1, M1, pts1, K2, M2, pts2, P)}

\PY{n}{F}\PY{p}{,} \PY{n}{inliers} \PY{o}{=} \PY{n}{ransacF}\PY{p}{(}\PY{n}{pts1}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{M}\PY{p}{)}
\PY{n}{pts1\PYZus{}inliers} \PY{o}{=} \PY{n}{pts1}\PY{p}{[}\PY{n}{inliers}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}\PY{p}{]}
\PY{n}{pts2\PYZus{}inliers} \PY{o}{=} \PY{n}{pts2}\PY{p}{[}\PY{n}{inliers}\PY{o}{.}\PY{n}{flatten}\PY{p}{(}\PY{p}{)}\PY{p}{]}
\PY{n}{M2}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{P} \PY{o}{=} \PY{n}{findM2}\PY{p}{(}\PY{n}{F}\PY{p}{,} \PY{n}{pts1\PYZus{}inliers}\PY{p}{,} \PY{n}{pts2\PYZus{}inliers}\PY{p}{,} \PY{n}{intrinsics}\PY{p}{)}
\PY{n}{M1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{hstack}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{identity}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{M2\PYZus{}opt}\PY{p}{,} \PY{n}{P\PYZus{}opt}\PY{p}{,} \PY{n}{obj\PYZus{}start}\PY{p}{,} \PY{n}{obj\PYZus{}end} \PY{o}{=} \PY{n}{bundleAdjustment}\PY{p}{(}\PY{n}{K1}\PY{p}{,} \PY{n}{M1}\PY{p}{,} \PY{n}{pts1\PYZus{}inliers}\PY{p}{,} \PY{n}{K2}\PY{p}{,} \PY{n}{M2}\PY{p}{,} \PY{n}{pts2\PYZus{}inliers}\PY{p}{,} \PY{n}{P}\PY{p}{)}

                                                     
\PY{c+c1}{\PYZsh{} END YOUR CODE}
\PY{n+nb}{print}\PY{p}{(}\PY{l+s+sa}{f}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Before reprojection error: }\PY{l+s+si}{\PYZob{}}\PY{n}{obj\PYZus{}start}\PY{l+s+si}{\PYZcb{}}\PY{l+s+s2}{, After: }\PY{l+s+si}{\PYZob{}}\PY{n}{obj\PYZus{}end}\PY{l+s+si}{\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
Before reprojection error: 352.8418820688559, After: 10.905073238047075
    \end{Verbatim}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{21}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} helper function for visualization}
\PY{k}{def} \PY{n+nf}{plot\PYZus{}3D\PYZus{}dual}\PY{p}{(}\PY{n}{P\PYZus{}before}\PY{p}{,} \PY{n}{P\PYZus{}after}\PY{p}{,} \PY{n}{azim}\PY{o}{=}\PY{l+m+mi}{70}\PY{p}{,} \PY{n}{elev}\PY{o}{=}\PY{l+m+mi}{45}\PY{p}{)}\PY{p}{:}
    \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
    \PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Blue: before; red: after}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{P\PYZus{}before}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{P\PYZus{}before}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{P\PYZus{}before}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{c} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{blue}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{P\PYZus{}after}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{P\PYZus{}after}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{P\PYZus{}after}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{red}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
    \PY{n}{ax}\PY{o}{.}\PY{n}{view\PYZus{}init}\PY{p}{(}\PY{n}{azim}\PY{o}{=}\PY{n}{azim}\PY{p}{,} \PY{n}{elev}\PY{o}{=}\PY{n}{elev}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{draw}\PY{p}{(}\PY{p}{)}

\PY{n}{P\PYZus{}init} \PY{o}{=} \PY{n}{P}
\PY{n}{P\PYZus{}final} \PY{o}{=} \PY{n}{P\PYZus{}opt}

\PY{c+c1}{\PYZsh{} plots the 3d points before and after BA from different viewpoints}
\PY{n}{plot\PYZus{}3D\PYZus{}dual}\PY{p}{(}\PY{n}{P\PYZus{}init}\PY{p}{,} \PY{n}{P\PYZus{}final}\PY{p}{,} \PY{n}{azim}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{elev}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)}
\PY{n}{plot\PYZus{}3D\PYZus{}dual}\PY{p}{(}\PY{n}{P\PYZus{}init}\PY{p}{,} \PY{n}{P\PYZus{}final}\PY{p}{,} \PY{n}{azim}\PY{o}{=}\PY{l+m+mi}{70}\PY{p}{,} \PY{n}{elev}\PY{o}{=}\PY{l+m+mi}{40}\PY{p}{)}
\PY{n}{plot\PYZus{}3D\PYZus{}dual}\PY{p}{(}\PY{n}{P\PYZus{}init}\PY{p}{,} \PY{n}{P\PYZus{}final}\PY{p}{,} \PY{n}{azim}\PY{o}{=}\PY{l+m+mi}{40}\PY{p}{,} \PY{n}{elev}\PY{o}{=}\PY{l+m+mi}{40}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_51_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_51_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_51_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{extra-credit-problem-6-multiview-keypoint-reconstruction}{%
\section{(Extra Credit) Problem 6: Multiview Keypoint
Reconstruction}\label{extra-credit-problem-6-multiview-keypoint-reconstruction}}

    \hypertarget{multi-view-reconstruction-of-keypoints}{%
\subsection{6 Multi-View Reconstruction of
keypoints}\label{multi-view-reconstruction-of-keypoints}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{ }{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{MultiviewReconstruction}\PY{p}{(}\PY{n}{C1}\PY{p}{,} \PY{n}{pts1}\PY{p}{,} \PY{n}{C2}\PY{p}{,} \PY{n}{pts2}\PY{p}{,} \PY{n}{C3}\PY{p}{,} \PY{n}{pts3}\PY{p}{,} \PY{n}{Thres} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Q6.1 Multi\PYZhy{}View Reconstruction of keypoints.}
\PY{l+s+sd}{      Input:  C1, the 3x4 camera matrix}
\PY{l+s+sd}{              pts1, the Nx3 matrix with the 2D image coordinates and confidence per row}
\PY{l+s+sd}{              C2, the 3x4 camera matrix}
\PY{l+s+sd}{              pts2, the Nx3 matrix with the 2D image coordinates and confidence per row}
\PY{l+s+sd}{              C3, the 3x4 camera matrix}
\PY{l+s+sd}{              pts3, the Nx3 matrix with the 2D image coordinates and confidence per row}
\PY{l+s+sd}{      Output: P, the Nx3 matrix with the corresponding 3D points for each keypoint per row}
\PY{l+s+sd}{              err, the reprojection error.}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{c+c1}{\PYZsh{} Replace pass with your implementation}
  \PY{c+c1}{\PYZsh{} \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{} TODO \PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}\PYZhy{}}
  \PY{c+c1}{\PYZsh{} YOUR CODE HERE}

  \PY{k}{return} \PY{n}{P}\PY{p}{,} \PY{n}{err}
  \PY{c+c1}{\PYZsh{} END YOUR CODE}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{plot-spatio-temporal-3d-keypoints}{%
\subsubsection{Plot Spatio-temporal (3D)
keypoints}\label{plot-spatio-temporal-3d-keypoints}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{ }{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{plot\PYZus{}3d\PYZus{}keypoint\PYZus{}video}\PY{p}{(}\PY{n}{pts\PYZus{}3d\PYZus{}video}\PY{p}{)}\PY{p}{:}
\PY{+w}{  }\PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{  Plot Spatio\PYZhy{}temporal (3D) keypoints}
\PY{l+s+sd}{      :param car\PYZus{}points: np.array points * 3}
\PY{l+s+sd}{  \PYZsq{}\PYZsq{}\PYZsq{}}

  \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
  \PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{k}{for} \PY{n}{pts\PYZus{}3d} \PY{o+ow}{in} \PY{n}{pts\PYZus{}3d\PYZus{}video}\PY{p}{:}
      \PY{n}{num\PYZus{}points} \PY{o}{=} \PY{n}{pts\PYZus{}3d}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
      \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{connections\PYZus{}3d}\PY{p}{)}\PY{p}{)}\PY{p}{:}
          \PY{n}{index0}\PY{p}{,} \PY{n}{index1} \PY{o}{=} \PY{n}{connections\PYZus{}3d}\PY{p}{[}\PY{n}{j}\PY{p}{]}
          \PY{n}{xline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
          \PY{n}{yline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}
          \PY{n}{zline} \PY{o}{=} \PY{p}{[}\PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index0}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{pts\PYZus{}3d}\PY{p}{[}\PY{n}{index1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{]}
          \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{xline}\PY{p}{,} \PY{n}{yline}\PY{p}{,} \PY{n}{zline}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{colors}\PY{p}{[}\PY{n}{j}\PY{p}{]}\PY{p}{)}
  \PY{n}{np}\PY{o}{.}\PY{n}{set\PYZus{}printoptions}\PY{p}{(}\PY{n}{threshold}\PY{o}{=}\PY{l+m+mf}{1e6}\PY{p}{,} \PY{n}{suppress}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
  \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{X Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Y Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{ax}\PY{o}{.}\PY{n}{set\PYZus{}zlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Z Label}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    Put it all together for all 10 timesteps.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{ }{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{pts\PYZus{}3d\PYZus{}video} \PY{o}{=} \PY{p}{[}\PY{p}{]}
\PY{k}{for} \PY{n}{loop} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{10}\PY{p}{)}\PY{p}{:}
  \PY{n+nb}{print}\PY{p}{(}\PY{l+s+sa}{f}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{processing time frame \PYZhy{} }\PY{l+s+si}{\PYZob{}}\PY{n}{loop}\PY{l+s+si}{\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

  \PY{n}{data\PYZus{}path} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/q6/}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{o}{+}\PY{n+nb}{str}\PY{p}{(}\PY{n}{loop}\PY{p}{)}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.npz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{image1\PYZus{}path} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/q6/}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cam1\PYZus{}time}\PY{l+s+s1}{\PYZsq{}}\PY{o}{+}\PY{n+nb}{str}\PY{p}{(}\PY{n}{loop}\PY{p}{)}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{image2\PYZus{}path} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/q6/}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cam2\PYZus{}time}\PY{l+s+s1}{\PYZsq{}}\PY{o}{+}\PY{n+nb}{str}\PY{p}{(}\PY{n}{loop}\PY{p}{)}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
  \PY{n}{image3\PYZus{}path} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{data/q6/}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{cam3\PYZus{}time}\PY{l+s+s1}{\PYZsq{}}\PY{o}{+}\PY{n+nb}{str}\PY{p}{(}\PY{n}{loop}\PY{p}{)}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

  \PY{n}{im1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{n}{image1\PYZus{}path}\PY{p}{)}
  \PY{n}{im2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{n}{image2\PYZus{}path}\PY{p}{)}
  \PY{n}{im3} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{n}{image3\PYZus{}path}\PY{p}{)}

  \PY{n}{data} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{p}{)}
  \PY{n}{pts1} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{pts2} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{pts3} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pts3}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}

  \PY{n}{K1} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{K2} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{K3} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{K3}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}

  \PY{n}{M1} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{M1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{M2} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{M2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
  \PY{n}{M3} \PY{o}{=} \PY{n}{data}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{M3}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}

  \PY{k}{if} \PY{n}{loop} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{loop}\PY{o}{==}\PY{l+m+mi}{9}\PY{p}{:}  \PY{c+c1}{\PYZsh{} feel free to modify to visualize keypoints at other loop timesteps}
    \PY{n}{img} \PY{o}{=} \PY{n}{visualize\PYZus{}keypoints}\PY{p}{(}\PY{n}{im2}\PY{p}{,} \PY{n}{pts2}\PY{p}{)}

  \PY{c+c1}{\PYZsh{} YOUR CODE HERE}

  \PY{c+c1}{\PYZsh{} END YOUR CODE}

  \PY{k}{if} \PY{n}{loop} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
    \PY{n}{plot\PYZus{}3d\PYZus{}keypoint}\PY{p}{(}\PY{n}{pts\PYZus{}3d}\PY{p}{)}

\PY{n}{plot\PYZus{}3d\PYZus{}keypoint\PYZus{}video}\PY{p}{(}\PY{n}{pts\PYZus{}3d\PYZus{}video}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
processing time frame - 0
    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_58_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_58_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
processing time frame - 1
processing time frame - 2
processing time frame - 3
processing time frame - 4
processing time frame - 5
processing time frame - 6
processing time frame - 7
processing time frame - 8
processing time frame - 9
    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_58_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{HW4_Reconstruction_files/HW4_Reconstruction_58_5.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{ }{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]

\end{Verbatim}
\end{tcolorbox}


    % Add a bibliography block to the postdoc
    
    
    
\end{document}
